# 양육 시스템 상세 가이드 (Nurturing System)

> **버전**: 2.0
> **최종 업데이트**: 2025-11-25
> **작성자**: Gemini

## 1. 시스템 개요

Puzzleletic의 양육 시스템은 실시간으로 캐릭터의 상태가 변화하는 다마고치 스타일의 시뮬레이션입니다. 사용자는 캐릭터의 3대 핵심 스탯을 관리하며, 방치할 경우 상태가 악화되고 결국 가출로 이어질 수 있습니다.

### 게임 루프
```
┌───────────────┐       ┌───────────────┐       ┌───────────────┐
│   캐릭터 돌보기   │ ◀─── │    스탯 하락    │ ◀─── │    시간 경과    │
│ (먹이, 약, 청소)│       │ (배고픔, 아픔)  │       │   (Game Tick)   │
└───────────────┘       └───────────────┘       └───────────────┘
       │                                               ▲
       ▼                                               │
┌───────────────┐       ┌───────────────┐       ┌───────────────┐
│   스탯 회복     │ ───▶ │  학습/놀이 가능 │ ───▶ │   재화 획득     │
│ (컨디션 최상)   │       │  (요구 스탯 충족) │       │ (학습 보상)     │
└───────────────┘       └───────────────┘       └───────────────┘
```

## 2. 핵심 메커니즘: 게임 틱 (Game Tick)

게임의 모든 자동 변화는 **게임 틱**을 기준으로 발생합니다.

- **틱 간격**: `5000ms` (5초) 마다 1틱
- **핵심 로직**: `src/services/gameTickService.ts`의 `executeGameTick` 함수
- **실행 주체**: `src/contexts/NurturingContext.tsx`

### 틱 실행 순서
매 5초마다 다음 로직이 순차적으로 실행됩니다.
1.  **자연 감소**: 모든 스탯이 소량 감소합니다.
2.  **상태 악화 페널티**: 특정 스탯이 임계점 이하일 경우 다른 스탯이 추가로 감소합니다. (악순환)
3.  **오염 페널티**: 맵에 존재하는 `똥(Poop)`과 `벌레(Bug)` 개수에 비례하여 스탯이 감소합니다.
4.  **벌레 생성**: 똥 개수에 따라 벌레가 생성될 확률이 증가합니다.
5.  **가출 상태 확인**: 모든 스탯이 0인지 체크하여 가출 카운트다운을 시작하거나 진행합니다.

## 3. 스탯 시스템

캐릭터는 3대 핵심 스탯을 가집니다. 모든 스탯은 0과 100 사이의 값을 가집니다.

| 스탯 | 영문 | 설명 | 자연 감소율 (5초당) |
| :--- | :--- | :--- | :--- |
| **포만감** | Fullness | 배고픔 정도. 0이 되면 건강과 행복이 빠르게 감소. | **-0.8** (가장 빠름) |
| **건강** | Health | 청결도와 질병을 포함하는 종합 건강 지수. | **-0.04** (매우 느림) |
| **행복도** | Happiness | 캐릭터의 기분. 낮으면 건강에 악영향. | **-0.3** |

### 스탯 상태 레벨
스탯 값에 따라 4단계의 상태로 나뉩니다.
- **Excellent (최상)**: 80-100
- **Normal (정상)**: 50-80
- **Warning (주의)**: 20-50
- **Critical (위험)**: 0-20

## 4. 상태 악화 시스템 (Vicious Cycle)

하나의 스탯이 나빠지면 다른 스탯에 연쇄적으로 악영향을 미쳐 복구를 어렵게 만듭니다.

| 조건 | 페널티 (5초당) | 설명 |
| :--- | :--- | :--- |
| **심각한 배고픔**<br/>(포만감 < 20) | • 행복도: **-1.2**<br/>• 건강: **-1.0** | "배고파서 기분도 안 좋고 힘도 없어요..." |
| **경미한 배고픔**<br/>(포만감 20-40) | • 행복도: **-0.6**<br/>• 건강: **-0.5** | "슬슬 배가 고파오기 시작했어요..." |
| **아픔**<br/>(건강 < 50) | • 행복도: **-1.5** | "너무 아파서 아무것도 하기 싫어요..." |
| **불행**<br/>(행복도 < 20) | • 건강: **-0.5** | "스트레스 때문에 건강이 나빠지는 것 같아요..." |

## 5. 오염 시스템: 똥과 벌레

### 똥 (Poop)
- **생성**: 음식을 먹으면 일정 확률과 시간 후에 생성됩니다. (`pendingPoopScheduled`)
- **최대 개수**: 5개
- **페널티 (5초당)**:
  - 1개: 건강 -0.5
  - 2개: 건강 -1.0
  - 3개 이상: 건강 -2.0
  - 개당 행복도 -0.4 추가 감소

### 벌레 (Bug)
- **생성**: 5초마다 일정 확률(`BUG_CONFIG.SPAWN_CHANCE`)로 생성됩니다.
- **확률 증가**: 똥 1개당 생성 확률이 `5%`씩 증가합니다.
- **최대 개수**: 3마리
- **페널티 (5초당, 1마리당)**:
  - 건강: -0.3
  - 행복도: -0.2

## 6. 행동 시스템 (`actionService.ts`)

사용자의 상호작용은 `actionService.ts`를 통해 처리됩니다.

| 행동 | 주요 효과 | 부가 효과/비용 |
| :--- | :--- | :--- |
| **음식 먹이기** | • 포만감 +10<br/>• 행복도 +10 | • **(건강식)** 건강 +3~5<br/>• 똥 생성 예약 |
| **약 먹이기** | • 건강 +15 | • 행복도 -5 (약이 써서) |
| **청소하기 (빗자루)** | • 건강 +5<br/>• 행복도 +10 | • **(무료)** 모든 똥 제거 |
| **벌레 잡기 (신문지)** | - | • **(무료)** 벌레 1마리 제거 |
| **샤워하기** | • 건강/행복도 대폭 상승 | • **(비용 5 glo)** 샤워 연출 및 버블 효과 |
| **양치하기 (칫솔)** | • 건강 +3<br/>• 행복도 +2 | • **(무료)** 양치 연출 및 치아 반짝임 효과 |
| **로봇 청소기** | • 건강/행복도 상승 | • **(비용 300 glo)** 모든 똥과 벌레 즉시 제거 |
| **놀아주기** | • 행복도 +20 | • **(비용)** 포만감 -10 |
| **학습하기** | • 행복도 +20<br/>• **재화 +10** | • **(비용)** 포만감 -10<br/>• **(조건)** 스탯 30/30/20 이상<br/>• **(보너스)** 모든 스탯 80+ 시 재화 2배 |

## 7. 가출 시스템

캐릭터를 장기간 방치하면 가출하며, 이는 **복구할 수 없습니다.**

### 가출 프로세스
1.  **카운트다운 시작**: 모든 스탯(포만감, 건강, 행복)이 0이 되는 순간, 7일(168시간) 카운트다운이 시작됩니다.
2.  **상태 변화**:
    - **위험 (Danger)**: 0 ~ 1.75일
    - **위기 (Critical)**: 1.75 ~ 3.5일
    - **이탈 예고 (Leaving)**: 3.5 ~ 7일
    - **가출 (Abandoned)**: 7일 경과 후
3.  **카운트다운 리셋**: 스탯 중 하나라도 0보다 커지면 카운트다운은 즉시 초기화됩니다.
4.  **UI 표시**: `getAbandonmentStatusUI` 함수가 현재 가출 상태에 맞는 메시지를 반환하여 UI에 표시합니다.

## 8. 시각 및 청각 피드백 (Visual & Audio Feedback)

사용자의 행동과 캐릭터의 상태에 따라 풍부한 피드백을 제공합니다.

### 감정 표현 (Emotion Bubbles)
- **발동 조건**: 캐릭터 클릭, 특정 상태 도달(배고픔, 아픔 등), 행동 완료 시
- **종류**:
  - `joy`: 기쁨, 만족 (레벨 1~3)
  - `sad`: 슬픔, 우울
  - `worried`: 걱정, 배고픔
  - `sick`: 아픔
  - `playful`: 장난기, 즐거움
- **자동 감정 표현**: 캐릭터의 상태(배고픔, 똥 많음 등)에 따라 주기적으로 말풍선이 나타나 상태를 알립니다.

### 특수 효과
- **샤워**: 샤워기 사용 시 물줄기(`🚿`)와 비누거품(`🫧`) 애니메이션이 연출됩니다.
- **식사/치료**: 음식을 먹거나 주사를 맞을 때 아이콘이 캐릭터에게 날아가는 애니메이션이 재생됩니다.

### 사운드 효과
- 버튼 클릭, 식사, 청소, 샤워 등 주요 상호작용 시 적절한 효과음이 재생됩니다.
- `SoundContext`를 통해 음소거 설정이 가능합니다.

## 9. 데이터 영속성 및 오프라인 진행

- **저장소**: `localStorage` (`puzzleletic_nurturing_state` 키)
- **저장 시점**: 상태가 변경될 때마다 `persistenceService.ts`의 `saveNurturingState`가 호출됩니다.
- **오프라인 진행**:
  1.  앱 로드 시 `applyOfflineProgress` 함수가 호출됩니다.
  2.  `마지막 접속 시간`과 `현재 시간`의 차이를 계산하여 경과된 틱(Tick) 수를 구합니다.
  3.  경과된 틱 수만큼 `executeGameTick`을 반복 실행하여 최종 스탯을 계산하고 적용합니다. 이로 인해 며칠간 접속하지 않으면 스탯이 크게 감소하고 똥과 벌레가 쌓일 수 있습니다.

## 10. 밸런스 조정 가이드

게임의 난이도는 `src/constants/nurturing.ts` 파일의 값들을 수정하여 조정할 수 있습니다.

- **`TICK_INTERVAL_MS`**: 게임 템포 조절 (값을 낮추면 게임이 빨라지고 어려워짐)
- **`NATURAL_DECAY`**: 스탯의 자연 감소율. (값을 높이면 더 빨리 허기지고 불행해짐)
- **`*_PENALTY`**: 상태 악화 시 페널티 강도. (값을 높이면 방치했을 때의 위험이 커짐)
- **`THRESHOLDS`**: 스탯 경고 임계점. (값을 높이면 더 빨리 '주의' 또는 '위험' 상태가 됨)
- **`FOOD_EFFECTS`, `MEDICINE_EFFECTS` 등**: 행동의 효과. (값을 높이면 아이템 효율이 좋아져 쉬워짐)

---
**관련 파일**
- **타입**: `src/types/nurturing.ts`
- **상수**: `src/constants/nurturing.ts`
- **서비스**: `src/services/gameTickService.ts`, `actionService.ts`, `persistenceService.ts`
- **컨텍스트**: `src/contexts/NurturingContext.tsx`
